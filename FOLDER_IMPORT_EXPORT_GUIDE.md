# 檔案夾匯出/匯入功能說明

## 功能概覽

新增了檔案夾的匯出和匯入功能，讓您可以備份和分享整個檔案夾結構（包括所有子檔案夾和頁面）。

### 新功能清單

1. ✅ **匯出檔案夾** - 將選中的檔案夾及其所有內容導出為 JSON 文件
2. ✅ **匯入檔案夾** - 從 JSON 文件匯入檔案夾到 Recycle 資源回收區
3. ✅ **Recycle 資源回收區** - 專門用於存放匯入的檔案夾，可直接刪除
4. ✅ **拖放移動** - Recycle 內的檔案夾可以移出到其他位置

---

## 使用說明

### 1. 匯出檔案夾

#### 步驟：
1. 在左側 Folder Tree 選擇要匯出的檔案夾
2. 點擊右上角的 💾（存檔）圖標
3. 選擇「📤 匯出檔案夾」
4. 文件會自動下載到您的下載目錄

#### 文件命名規則：
```
{檔案夾名稱}_{日期}.json

範例：
MyProject_2025-11-09.json
工作筆記_2025-11-09.json
```

#### 匯出內容：
- ✅ 選中的檔案夾
- ✅ 所有子檔案夾（遞迴）
- ✅ 所有相關頁面
- ✅ 完整的階層結構
- ✅ 所有 Markdown 內容
- ✅ 創建和修改時間

---

### 2. 匯入檔案夾

#### 步驟：
1. 點擊右上角的 💾（存檔）圖標
2. 選擇「📥 匯入檔案夾」
3. 選擇之前匯出的 JSON 文件
4. 檔案夾會自動匯入到 **Recycle** 檔案夾下

#### 匯入後的行為：
- ✅ 自動創建 Recycle 檔案夾（如果不存在）
- ✅ 自動展開 Recycle 檔案夾
- ✅ 自動選中 Recycle 檔案夾
- ✅ 所有 ID 會重新生成（避免衝突）
- ✅ 時間戳會更新為當前時間

---

### 3. Recycle 資源回收區

#### 特性：

**自動創建：**
- 第一次匯入時，系統會自動創建 Recycle 檔案夾
- Recycle 始終位於根目錄

**刪除規則：**
- **普通檔案夾**：只能刪除空白頁面的檔案夾
- **Recycle 及其子檔案夾**：可以直接刪除，不檢查內容
- 刪除時會顯示確認對話框

**移動自由：**
- Recycle 內的檔案夾可以拖放移出到其他位置
- 其他位置的檔案夾也可以拖放移入 Recycle

---

## 數據格式

### JSON 文件結構

```json
{
  "version": "1.0",
  "exportDate": 1699564800000,
  "folderName": "MyProject",
  "rootFolderId": "folder-123",
  "folders": [
    {
      "id": "folder-123",
      "name": "MyProject",
      "parentId": null,
      "order": 0,
      "createdAt": 1699564800000,
      "updatedAt": 1699564800000
    },
    {
      "id": "folder-456",
      "name": "SubFolder",
      "parentId": "folder-123",
      "order": 0,
      "createdAt": 1699564800000,
      "updatedAt": 1699564800000
    }
  ],
  "pages": [
    {
      "id": "page-789",
      "folderId": "folder-123",
      "name": "My Note",
      "content": "# My Note\n\nContent here...",
      "createdAt": 1699564800000,
      "updatedAt": 1699564800000
    }
  ]
}
```

### 字段說明：

| 字段 | 類型 | 說明 |
|------|------|------|
| version | string | 格式版本，當前為 "1.0" |
| exportDate | number | 匯出時間戳 |
| folderName | string | 根檔案夾名稱 |
| rootFolderId | string | 根檔案夾 ID |
| folders | Folder[] | 所有檔案夾數據 |
| pages | Page[] | 所有頁面數據 |

---

## UI 說明

### 存檔按鈕位置

```
┌─────────────────────────────┐
│ Folder Tree                  │
├─────────────────────────────┤
│  [新增檔案夾]         [💾]  │  ← 存檔按鈕在右上角
├─────────────────────────────┤
│  📁 Folder 1                │
│  📁 Folder 2                │
│  📁 Recycle                 │  ← 自動創建
└─────────────────────────────┘
```

### 下拉選單

點擊 💾 圖標後會顯示：

```
┌─────────────────────┐
│ 📤 匯出檔案夾       │  ← 需要先選擇檔案夾
│ 📥 匯入檔案夾       │  ← 隨時可用
└─────────────────────┘
```

---

## 使用場景

### 1. 備份數據
```
定期匯出重要的檔案夾
→ 保存到雲端硬碟或外接硬碟
→ 建立版本歷史記錄
```

### 2. 分享內容
```
匯出專案檔案夾
→ 傳送 JSON 文件給同事
→ 對方匯入到 Recycle
→ 移動到適當位置
```

### 3. 遷移數據
```
從舊系統匯出
→ 匯入到新系統的 Recycle
→ 檢查內容
→ 移動到正式位置
```

### 4. 測試和實驗
```
匯入測試數據到 Recycle
→ 進行測試
→ 直接刪除 Recycle 清理
```

---

## 技術實現

### 文件清單

#### 新增文件：
1. **`src/utils/folderImportExport.ts`** - 匯出/匯入邏輯
2. **`src/services/recycleBin.ts`** - Recycle 檔案夾管理

#### 修改文件：
1. **`src/services/db.ts`** - 添加 `getAllPages()` 方法
2. **`src/components/FolderTree.tsx`** - UI 和處理邏輯
3. **`src/styles/editor.css`** - 新增樣式

### 核心函數

#### 匯出：`exportFolder(folderId: string)`
```typescript
1. 獲取目標檔案夾
2. 遞迴收集所有子檔案夾
3. 收集所有相關頁面
4. 生成 JSON 數據
5. 創建 Blob 並下載
```

#### 匯入：`importFolder(file: File, parentFolderId: string)`
```typescript
1. 讀取並解析 JSON
2. 驗證格式和版本
3. 創建 ID 映射（舊 ID → 新 ID）
4. 按層級順序創建檔案夾
5. 創建所有頁面
```

#### Recycle 管理：`ensureRecycleFolderExists()`
```typescript
1. 檢查 Recycle 是否存在
2. 如果不存在則創建
3. 返回 Recycle 檔案夾對象
```

---

## 注意事項

### ⚠️ 重要提醒

1. **ID 重新生成**
   - 匯入時所有 ID 都會重新生成
   - 避免與現有數據衝突
   - 原始關聯關係會保持

2. **時間戳更新**
   - `createdAt` 和 `updatedAt` 會設為匯入時間
   - 原始時間信息會遺失

3. **文件大小**
   - 匯出大型檔案夾時，JSON 文件可能很大
   - 建議分批匯出

4. **版本兼容性**
   - 當前版本：1.0
   - 未來版本升級時可能需要遷移工具

5. **Recycle 刪除**
   - 刪除 Recycle 會永久刪除所有內容
   - 請確認後再操作

---

## 錯誤處理

### 常見錯誤訊息

| 錯誤 | 原因 | 解決方法 |
|------|------|----------|
| "請先選擇要匯出的檔案夾" | 未選擇檔案夾 | 在左側選擇一個檔案夾 |
| "文件格式不正確" | JSON 格式錯誤 | 檢查文件是否完整 |
| "不支持的版本: X.X" | 版本不兼容 | 使用正確版本的文件 |
| "找不到指定的 folder" | 檔案夾不存在 | 檢查 folderId 是否正確 |

### 調試信息

匯出/匯入過程中，控制台會顯示詳細日誌：

```
✅ 匯出成功: MyProject_2025-11-09.json
✅ 創建 Recycle folder 成功
✅ 匯入成功: {folders: 5, pages: 12}
✅ 刪除 folder folder-123 成功
```

---

## 快捷鍵參考

雖然沒有直接的快捷鍵，但您可以：
1. 使用 Tab 鍵導航到存檔按鈕
2. 按 Enter 打開選單
3. 使用方向鍵選擇選項
4. 按 Enter 確認

---

## 更新日誌

### Version 1.0 (2025-11-09)
- ✅ 初始版本
- ✅ 基本匯出/匯入功能
- ✅ Recycle 檔案夾支持
- ✅ 遞迴處理子檔案夾
- ✅ 完整的 UI 整合

---

## 未來計劃

### 可能的改進：
- [ ] 支持多檔案夾批量匯出
- [ ] 壓縮格式支持（ZIP）
- [ ] 匯出時的選項設定（包含/排除子檔案夾）
- [ ] 匯入時的衝突處理策略
- [ ] 匯入預覽功能
- [ ] 拖放文件直接匯入

---

## 技術支持

如遇到問題，請：
1. 檢查瀏覽器控制台的錯誤信息
2. 確認 JSON 文件格式正確
3. 嘗試重新匯出/匯入
4. 查看本文檔的錯誤處理部分

---

**享受新的匯出/匯入功能！** 📦✨
